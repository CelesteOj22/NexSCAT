<!-- templates/main/dashboardAnalisisJerarquico.html -->
{% extends 'main/base.html' %}
{% load static %}

{% block title %}Dashboard de Métricas - NexScat{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       ESTILOS HEREDADOS (mantener los existentes)
       ============================================ */

    .dashboard-section {
        padding: 60px 0;
    }

    .dashboard-container {
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Loading overlay - mantener igual */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .loading-text {
        margin-top: 20px;
        font-size: 1.2rem;
        color: #667eea;
        font-weight: 600;
    }

    .loading-subtext {
        margin-top: 10px;
        font-size: 0.9rem;
        color: #6c757d;
    }

    /* Dashboard header - mantener igual */
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .dashboard-header h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
        font-weight: 600;
        color: white;
    }

    /* Stats cards - mantener igual */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card .number {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card .label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Filtros - mantener igual */
    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: block;
    }

    .filter-input {
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    .filter-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        outline: none;
    }

    /* Botones - mantener igual */
    .btn-icon-action {
        background: white;
        color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: 2px solid #e0e0e0;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 46px;
        height: 46px;
    }

    .btn-icon-action:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-icon-action:focus {
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-icon-action i {
        font-size: 1.2rem;
    }

    .btn-icon-action.dropdown-toggle::after {
        display: none;
    }

    /* Dropdown - mantener igual */
    .dropdown-menu {
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        border: 2px solid #e0e0e0;
        padding: 8px 0;
        min-width: 200px;
    }

    .dropdown-menu-end {
        right: 0;
        left: auto;
    }

    .dropdown-item {
        padding: 10px 20px;
        transition: all 0.2s ease;
        color: #495057;
        font-size: 0.95rem;
    }

    .dropdown-item:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .dropdown-item i {
        margin-right: 8px;
        width: 20px;
        text-align: center;
    }

    /* ============================================
       NUEVOS ESTILOS PARA TABLA JERÁRQUICA
       ============================================ */

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .hierarchical-table {
        width: 100%;
        margin-bottom: 0;
        border-collapse: collapse;
    }

    /* Encabezados */
    .hierarchical-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .hierarchical-table thead th {
        border: none;
        padding: 15px 10px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        vertical-align: middle;
        white-space: nowrap;
    }

    /* Filas */
    .hierarchical-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    .hierarchical-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .hierarchical-table td {
        padding: 12px 10px;
        vertical-align: middle;
    }

    /* Niveles jerárquicos con indentación */
    .hierarchy-level-0 {
        font-weight: 600;
        background-color: #f8f9fa;
    }

    .hierarchy-level-1 {
        padding-left: 40px !important;
    }

    .hierarchy-level-2 {
        padding-left: 60px !important;
    }

    .hierarchy-level-3 {
        padding-left: 80px !important;
    }

    /* Expand/Collapse icons */
    .expand-icon {
        cursor: pointer;
        margin-right: 8px;
        transition: transform 0.2s ease;
        display: inline-block;
        width: 20px;
        text-align: center;
        color: #667eea;
        font-size: 0.9rem;
    }

    .expand-icon.expanded {
        transform: rotate(90deg);
    }

    .expand-icon:hover {
        color: #764ba2;
    }

    /* Filas hijas (hidden por defecto) */
    .child-row {
        display: none;
    }

    .child-row.visible {
        display: table-row;
    }

    /* Project row (nivel 0) */
    .project-row {
        font-weight: 600;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .project-row td {
        border-bottom: 2px solid #667eea;
    }

    .project-name {
        font-size: 1.1rem;
        color: #667eea;
        font-weight: 600;
    }

    /* Measure rows (métricas) */
    .measure-row {
        font-size: 0.95rem;
    }

    .measure-name {
        color: #495057;
    }

    .measure-value {
        font-weight: 600;
        color: #667eea;
        font-size: 1.05rem;
        text-align: center;
    }

    /* Component row (nivel 1) */
    .component-row {
        background-color: rgba(79, 172, 254, 0.08);
    }

    .component-name {
        font-weight: 600;
        color: #4facfe;
        cursor: help;
    }

    .component-name:hover {
        color: #00f2fe;
        text-decoration: underline;
    }

    /* Tooltip más ancho para paths largos */
    .tooltip-inner {
        max-width: 400px;
        text-align: left;
    }

    /* Class row (nivel 2) */
    .class-row {
        background-color: rgba(92, 184, 92, 0.08);
    }

    .class-name {
        color: #5cb85c;
        font-weight: 600;
        cursor: help;
    }

    .class-name:hover {
        color: #449d44;
        text-decoration: underline;
    }

    /* Badges */
    .badge-level {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .badge-level.proyecto {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .badge-level.componente {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .badge-level.clase {
        background: linear-gradient(135deg, #5cb85c 0%, #449d44 100%);
        color: white;
    }

    /* Estado vacío */
    .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .no-results i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.3;
    }

    /* Responsive */
    @media (max-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .hierarchical-table {
            font-size: 0.9rem;
        }

        .hierarchy-level-1 {
            padding-left: 30px !important;
        }

        .hierarchy-level-2 {
            padding-left: 50px !important;
        }

        .hierarchy-level-3 {
            padding-left: 70px !important;
        }
    }

    @media (max-width: 576px) {
        .dashboard-header h1 {
            font-size: 1.4rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .stat-card .number {
            font-size: 2rem;
        }

        .hierarchical-table {
            font-size: 0.85rem;
        }

        .hierarchy-level-1 {
            padding-left: 20px !important;
        }

        .hierarchy-level-2 {
            padding-left: 35px !important;
        }

        .hierarchy-level-3 {
            padding-left: 50px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay active" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Cargando métricas...</div>
    <div class="loading-subtext">Por favor espera un momento</div>
</div>

<div class="dashboard-section">
    <div class="container-xxl px-lg-5 dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>Dashboard de Análisis</h1>
            <p class="mb-0">Vista estructurada de proyectos, componentes y métricas</p>
        </div>

        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">Proyectos</div>
                <div class="number">{{ total_projects }}</div>
            </div>
            <div class="stat-card">
                <div class="label">Total de Métricas a Nivel de {{selected_level}}</div>
                <div class="number">{{ total_measures }}</div>
            </div>
            <div class="stat-card">
                <div class="label">Último Análisis</div>
                <div class="number" style="font-size: 1.2rem;">
                    {% if last_analysis %}
                        {{ last_analysis|date:"d/m/Y" }}
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="row g-1">
                <div class="col-lg-2 col-md-4 filter-group">
                    <label for="filterSearch">Búsqueda</label>
                    <input type="text" id="filterSearch" class="form-control filter-input"
                           placeholder="Buscar...">
                </div>
                <div class="col-lg-2 col-md-4 filter-group">
                    <label for="filterProject">Proyecto</label>
                    <select id="filterProject" class="form-select filter-input">
                        <option value="">Todos</option>
                        {% for project in projects %}
                        <option value="{{ project.name }}">{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-4 filter-group">
                    <label for="filterMetric">Métrica</label>
                    <select id="filterMetric" class="form-select filter-input">
                        <option value="">Todas</option>
                        {% for metric in metrics %}
                        <option value="{{ metric.name }}">{{ metric.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-4 filter-group">
                    <label for="filterTool">Herramienta</label>
                    <select id="filterTool" class="form-select filter-input">
                        <option value="">Todas</option>
                        {% for tool in tools %}
                        <option value="{{ tool }}">{{ tool }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-4 filter-group">
                    <label for="filterLevel">Nivel</label>
                    <select id="filterLevel" class="form-select filter-input" onchange="changeLevel()">
                        <option value="Proyecto" {% if selected_level == 'Proyecto' %}selected{% endif %}>Proyecto</option>
                        <option value="Componente" {% if selected_level == 'Componente' %}selected{% endif %}>Componente</option>
                        <option value="Clase" {% if selected_level == 'Clase' %}selected{% endif %}>Clase</option>
                        <option value="Todos" {% if selected_level == 'Todos' %}selected{% endif %}>Todos ⚠️</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-4 filter-group">
                    <label>Acciones</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-icon-action" onclick="resetFilters()"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Limpiar filtros">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-icon-action" onclick="expandAll()"
                                data-bs-toggle="tooltip" title="Expandir todo">
                            <i class="bi bi-arrows-expand"></i>
                        </button>
                        <button class="btn btn-icon-action" onclick="collapseAll()"
                                data-bs-toggle="tooltip" title="Contraer todo">
                            <i class="bi bi-arrows-collapse"></i>
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-icon-action dropdown-toggle"
                                    data-bs-toggle="dropdown" aria-expanded="false"
                                    data-bs-original-title="Exportar datos">
                                <i class="bi bi-file-earmark-arrow-down"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="exportToCSV(); return false;">
                                    <i class="bi bi-filetype-csv"></i> Exportar como CSV
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToJSON(); return false;">
                                    <i class="bi bi-filetype-json"></i> Exportar como JSON
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="exportToXML(); return false;">
                                    <i class="bi bi-filetype-xml"></i> Exportar como XML
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Jerárquica -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table hierarchical-table" id="hierarchicalTable">
                    <thead>
                        <tr>
                            <th>Entidad / Métrica</th>
                            <th>Nivel</th>
                            <th>Dominio</th>
                            <th>Herramienta</th>
                            <th>Valor</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        {% for project_node in hierarchical_data %}
                            <!-- PROJECT ROW -->
                            <tr class="project-row hierarchy-level-0"
                                data-id="{{ project_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-type="project">
                                <td>
                                    <span class="expand-icon" onclick="toggleNode('{{ project_node.id }}')">
                                        <i class="bi bi-caret-right-fill"></i>
                                    </span>
                                    <strong class="project-name">{{ project_node.project_name }}</strong>
                                    <small class="text-muted d-block" style="padding-left: 28px;">
                                        Key: {{ project_node.project_key }}
                                    </small>
                                </td>
                                <td><span class="badge-level proyecto">PROYECTO</span></td>
                                <td colspan="3"></td>
                                <td>
                                    {% if project_node.last_analysis %}
                                        <small>Último análisis: {{ project_node.last_analysis|date:"d/m/Y" }}</small>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- PROJECT MEASURES -->
                            {% for measure in project_node.measures %}
                            <tr class="child-row measure-row hierarchy-level-1"
                                data-parent="{{ project_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-metric="{{ measure.metric_name }}"
                                data-tool="{{ measure.tool }}"
                                data-type="measure">
                                <td class="hierarchy-level-1">
                                    <span class="measure-name">{{ measure.metric_name }}</span>
                                </td>
                                <td><span class="badge-level proyecto">MÉTRICA</span></td>
                                <td><small>{{ measure.domain }}</small></td>
                                <td><small>{{ measure.tool }}</small></td>
                                <td class="measure-value">{{ measure.value }}</td>
                                <td><small class="text-muted">{{ measure.description|truncatewords:10 }}</small></td>
                            </tr>
                            {% endfor %}

                            <!-- COMPONENTS -->
                            {% for component_node in project_node.components %}
                            <tr class="child-row component-row hierarchy-level-1"
                                data-id="{{ component_node.id }}"
                                data-parent="{{ project_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-type="component">
                                <td class="hierarchy-level-1">
                                    {% if component_node.measures or component_node.classes %}
                                    <span class="expand-icon" onclick="toggleNode('{{ component_node.id }}')">
                                        <i class="bi bi-caret-right-fill"></i>
                                    </span>
                                    {% endif %}
                                    <span class="component-name" data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            data-bs-html="true"
                                            title="<strong>Path completo:</strong><br>{{ component_node.component_path }}">
                                        {{ component_node.component_display_name }}
                                    </span>
                                    <small class="text-muted d-block" style="padding-left: 28px;">
                                        {{ component_node.qualifier }}
                                    </small>
                                </td>
                                <td><span class="badge-level componente">COMPONENTE</span></td>
                                <td colspan="4"></td>
                            </tr>

                            <!-- COMPONENT MEASURES -->
                            {% for measure in component_node.measures %}
                            <tr class="child-row measure-row hierarchy-level-2"
                                data-parent="{{ component_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-metric="{{ measure.metric_name }}"
                                data-tool="{{ measure.tool }}"
                                data-type="measure">
                                <td class="hierarchy-level-2">
                                    <span class="measure-name">{{ measure.metric_name }}</span>
                                </td>
                                <td><span class="badge-level componente">MÉTRICA</span></td>
                                <td><small>{{ measure.domain }}</small></td>
                                <td><small>{{ measure.tool }}</small></td>
                                <td class="measure-value">{{ measure.value }}</td>
                                <td><small class="text-muted">{{ measure.description|truncatewords:10 }}</small></td>
                            </tr>
                            {% endfor %}

                            <!-- CLASSES -->
                            {% for class_node in component_node.classes %}
                            <tr class="child-row class-row hierarchy-level-2"
                                data-id="{{ class_node.id }}"
                                data-parent="{{ component_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-type="class">
                                <td class="hierarchy-level-2">
                                    {% if class_node.measures %}
                                    <span class="expand-icon" onclick="toggleNode('{{ class_node.id }}')">
                                        <i class="bi bi-caret-right-fill"></i>
                                    </span>
                                    {% endif %}
                                    <span class="class-name">{{ class_node.class_name }}</span>
                                </td>
                                <td><span class="badge-level clase">CLASE</span></td>
                                <td colspan="4"></td>
                            </tr>

                            <!-- CLASS MEASURES -->
                            {% for measure in class_node.measures %}
                            <tr class="child-row measure-row hierarchy-level-3"
                                data-parent="{{ class_node.id }}"
                                data-project="{{ project_node.project_name }}"
                                data-metric="{{ measure.metric_name }}"
                                data-tool="{{ measure.tool }}"
                                data-type="measure">
                                <td class="hierarchy-level-3">
                                    <span class="measure-name">{{ measure.metric_name }}</span>
                                </td>
                                <td><span class="badge-level clase">MÉTRICA</span></td>
                                <td><small>{{ measure.domain }}</small></td>
                                <td><small>{{ measure.tool }}</small></td>
                                <td class="measure-value">{{ measure.value }}</td>
                                <td><small class="text-muted">{{ measure.description|truncatewords:10 }}</small></td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td colspan="6">
                                <div class="no-results">
                                    <i class="bi bi-inbox"></i>
                                    <h4>No hay métricas disponibles</h4>
                                    <p>Importa proyectos para ver sus métricas aquí</p>
                                    <a href="{% url 'main:importarProyecto' %}" class="btn btn-primary mt-3">
                                        <i class="bi bi-plus-circle"></i> Importar Proyectos
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botón de Acción -->
        <div class="text-center mt-4">
            <a href="{% url 'main:importarProyecto' %}" class="btn btn-secondary-gradient py-2 px-4">
                <i class="bi bi-plus-circle"></i> Analizar Más Proyectos
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // LOADING OVERLAY
    // ============================================

    function showLoading(message = 'Cargando métricas...', subtext = 'Por favor espera un momento') {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;

        const textElement = overlay.querySelector('.loading-text');
        const subtextElement = overlay.querySelector('.loading-subtext');

        if (textElement) textElement.textContent = message;
        if (subtextElement) subtextElement.textContent = subtext;

        overlay.classList.add('active');
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;

        overlay.classList.remove('active');
    }

    // ============================================
    // EXPAND/COLLAPSE JERÁRQUICO
    // ============================================

    function toggleNode(nodeId) {
        const childRows = document.querySelectorAll(`[data-parent="${nodeId}"]`);
        const expandIcon = document.querySelector(`[data-id="${nodeId}"] .expand-icon i`);

        childRows.forEach(row => {
            row.classList.toggle('visible');
        });

        if (expandIcon) {
            const icon = expandIcon.closest('.expand-icon');
            icon.classList.toggle('expanded');
        }
    }

    function expandAll() {
        document.querySelectorAll('.child-row').forEach(row => {
            row.classList.add('visible');
        });
        document.querySelectorAll('.expand-icon').forEach(icon => {
            icon.classList.add('expanded');
        });
    }

    function collapseAll() {
        document.querySelectorAll('.child-row').forEach(row => {
            row.classList.remove('visible');
        });
        document.querySelectorAll('.expand-icon').forEach(icon => {
            icon.classList.remove('expanded');
        });
    }

    // ============================================
    // CAMBIO DE NIVEL
    // ============================================

    function changeLevel() {
        const selectElement = document.getElementById('filterLevel');
        if (!selectElement) return;

        const level = selectElement.value;

        if (level === 'Todos') {
            const confirmed = confirm('Cargar todas las métricas puede tardar varios segundos. ¿Deseas continuar?');
            if (!confirmed) {
                selectElement.value = '{{ selected_level }}';
                return;
            }
        }

        showLoading('Cambiando nivel de análisis...', 'Cargando ' + level.toLowerCase());

        setTimeout(() => {
            window.location.href = '?level=' + encodeURIComponent(level);
        }, 100);
    }

    // ============================================
    // FILTRADO
    // ============================================

    function filterTable() {
        const searchTerm = document.getElementById('filterSearch')?.value.toLowerCase() || '';
        const projectFilter = document.getElementById('filterProject')?.value.toLowerCase() || '';
        const metricFilter = document.getElementById('filterMetric')?.value.toLowerCase() || '';
        const toolFilter = document.getElementById('filterTool')?.value.toLowerCase() || '';

        const tbody = document.getElementById('tableBody');
        if (!tbody) return;

        const rows = tbody.getElementsByTagName('tr');
        let visibleCount = 0;

        for (let row of rows) {
            const project = row.getAttribute('data-project')?.toLowerCase() || '';
            const metric = row.getAttribute('data-metric')?.toLowerCase() || '';
            const tool = row.getAttribute('data-tool')?.toLowerCase() || '';
            const text = row.textContent.toLowerCase();

            const matchesSearch = searchTerm === '' || text.includes(searchTerm);
            const matchesProject = projectFilter === '' || project.includes(projectFilter);
            const matchesMetric = metricFilter === '' || metric.includes(metricFilter);
            const matchesTool = toolFilter === '' || tool.includes(toolFilter);

            if (matchesSearch && matchesProject && matchesMetric && matchesTool) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }

    // ============================================
    // EXPORTACIÓN (usar las funciones del archivo anterior)
    // ============================================

    function exportToCSV() {
        exportToCSVHierarchical();
    }

    function exportToJSON() {
        exportToJSONHierarchical();
    }

    function exportToXML() {
        exportToXMLHierarchical();
    }

    async function exportToCSVHierarchical() {
        showLoading('Exportando a CSV...', 'Generando estructura jerárquica');

        try {
            const level = document.getElementById('filterLevel')?.value || 'Todos';
            const response = await fetch(`/api/export/hierarchical/?level=${encodeURIComponent(level)}`);
            const result = await response.json();
            const data = result.data;

            let csv = 'Nivel,Proyecto ID,Proyecto,Entidad,Métrica,Dominio,Herramienta,Tipo,Valor,Descripción\n';

            data.forEach(projectData => {
                const project = projectData.project;

                // Métricas del proyecto
                projectData.project_measures.forEach(measure => {
                    const row = [
                        'PROYECTO',
                        project.id,
                        escapeCSV(project.name),
                        escapeCSV(project.name),
                        escapeCSV(measure.name),
                        escapeCSV(measure.domain),
                        escapeCSV(measure.tool),
                        escapeCSV(measure.type),
                        escapeCSV(measure.value),
                        escapeCSV(measure.description)
                    ];
                    csv += row.join(',') + '\n';
                });

                // Componentes
                projectData.components.forEach(componentData => {
                    const component = componentData.component;

                    // Métricas del componente
                    componentData.component_measures.forEach(measure => {
                        const row = [
                            'COMPONENTE',
                            project.id,
                            escapeCSV(project.name),
                            escapeCSV(component.path),
                            escapeCSV(measure.name),
                            escapeCSV(measure.domain),
                            escapeCSV(measure.tool),
                            escapeCSV(measure.type),
                            escapeCSV(measure.value),
                            escapeCSV(measure.description)
                        ];
                        csv += row.join(',') + '\n';
                    });

                    // Clases
                    componentData.classes.forEach(classData => {
                        const classObj = classData.class;

                        classData.class_measures.forEach(measure => {
                            const row = [
                                'CLASE',
                                project.id,
                                escapeCSV(project.name),
                                escapeCSV(classObj.name),
                                escapeCSV(measure.name),
                                escapeCSV(measure.domain),
                                escapeCSV(measure.tool),
                                escapeCSV(measure.type),
                                escapeCSV(measure.value),
                                escapeCSV(measure.description)
                            ];
                            csv += row.join(',') + '\n';
                        });
                    });
                });
            });

            downloadFile(csv, 'text/csv', 'metricas_jerarquico', 'csv');
            hideLoading();

        } catch (error) {
            console.error('Error:', error);
            hideLoading();
            alert('Error al exportar CSV: ' + error.message);
        }
    }

    async function exportToJSONHierarchical() {
        showLoading('Exportando a JSON...', 'Generando estructura jerárquica');

        try {
            const level = document.getElementById('filterLevel')?.value || 'Todos';
            const response = await fetch(`/api/export/hierarchical/?level=${encodeURIComponent(level)}`);
            const result = await response.json();

            const json = JSON.stringify(result.data, null, 2);
            downloadFile(json, 'application/json', 'metricas_jerarquico', 'json');
            hideLoading();

        } catch (error) {
            console.error('Error:', error);
            hideLoading();
            alert('Error al exportar JSON: ' + error.message);
        }
    }

    async function exportToXMLHierarchical() {
        showLoading('Exportando a XML...', 'Generando estructura jerárquica');

        try {
            const level = document.getElementById('filterLevel')?.value || 'Todos';
            const response = await fetch(`/api/export/hierarchical/?level=${encodeURIComponent(level)}`);
            const result = await response.json();
            const data = result.data;

            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<projects>\n';

            data.forEach(projectData => {
                const project = projectData.project;

                xml += '  <project>\n';
                xml += `    <idproject>${escapeXML(project.id)}</idproject>\n`;
                xml += `    <key>${escapeXML(project.key)}</key>\n`;
                xml += `    <name>${escapeXML(project.name)}</name>\n`;
                xml += `    <qualifier>${escapeXML(project.qualifier)}</qualifier>\n`;
                xml += `    <lastAnalysis>${escapeXML(project.lastAnalysis || '')}</lastAnalysis>\n`;

                // Project measures
                xml += '    <project_measures>\n';
                projectData.project_measures.forEach(measure => {
                    xml += '      <project_measure>\n';
                    xml += `        <domain>${escapeXML(measure.domain)}</domain>\n`;
                    xml += `        <key>${escapeXML(measure.key)}</key>\n`;
                    xml += `        <name>${escapeXML(measure.name)}</name>\n`;
                    xml += `        <description>${escapeXML(measure.description)}</description>\n`;
                    xml += `        <type>${escapeXML(measure.type)}</type>\n`;
                    xml += `        <value>${escapeXML(measure.value)}</value>\n`;
                    xml += `        <tool>${escapeXML(measure.tool)}</tool>\n`;
                    xml += '      </project_measure>\n';
                });
                xml += '    </project_measures>\n';

                // Components
                xml += '    <components>\n';
                projectData.components.forEach(componentData => {
                    const component = componentData.component;

                    xml += '      <component>\n';
                    xml += `        <idcomponent>${escapeXML(component.id)}</idcomponent>\n`;
                    xml += `        <name>${escapeXML(component.name)}</name>\n`;
                    xml += `        <qualifier>${escapeXML(component.qualifier)}</qualifier>\n`;
                    xml += `        <path>${escapeXML(component.path)}</path>\n`;
                    xml += `        <language>${escapeXML(component.language)}</language>\n`;

                    // Component measures
                    xml += '        <component_measures>\n';
                    componentData.component_measures.forEach(measure => {
                        xml += '          <component_measure>\n';
                        xml += `            <domain>${escapeXML(measure.domain)}</domain>\n`;
                        xml += `            <key>${escapeXML(measure.key)}</key>\n`;
                        xml += `            <name>${escapeXML(measure.name)}</name>\n`;
                        xml += `            <description>${escapeXML(measure.description)}</description>\n`;
                        xml += `            <type>${escapeXML(measure.type)}</type>\n`;
                        xml += `            <value>${escapeXML(measure.value)}</value>\n`;
                        xml += `            <tool>${escapeXML(measure.tool)}</tool>\n`;
                        xml += '          </component_measure>\n';
                    });
                    xml += '        </component_measures>\n';

                    // Classes
                    xml += '        <classes>\n';
                    componentData.classes.forEach(classData => {
                        const classObj = classData.class;

                        xml += '          <class>\n';
                        xml += `            <idclass>${escapeXML(classObj.id)}</idclass>\n`;
                        xml += `            <name>${escapeXML(classObj.name)}</name>\n`;
                        xml += `            <qualifier>${escapeXML(classObj.qualifier)}</qualifier>\n`;

                        // Class measures
                        xml += '            <class_measures>\n';
                        classData.class_measures.forEach(measure => {
                            xml += '              <class_measure>\n';
                            xml += `                <domain>${escapeXML(measure.domain)}</domain>\n`;
                            xml += `                <key>${escapeXML(measure.key)}</key>\n`;
                            xml += `                <name>${escapeXML(measure.name)}</name>\n`;
                            xml += `                <description>${escapeXML(measure.description)}</description>\n`;
                            xml += `                <type>${escapeXML(measure.type)}</type>\n`;
                            xml += `                <value>${escapeXML(measure.value)}</value>\n`;
                            xml += `                <tool>${escapeXML(measure.tool)}</tool>\n`;
                            xml += '              </class_measure>\n';
                        });
                        xml += '            </class_measures>\n';

                        xml += '          </class>\n';
                    });
                    xml += '        </classes>\n';

                    xml += '      </component>\n';
                });
                xml += '    </components>\n';

                xml += '  </project>\n';
            });

            xml += '</projects>';

            downloadFile(xml, 'application/xml', 'metricas_jerarquico', 'xml');
            hideLoading();

        } catch (error) {
            console.error('Error:', error);
            hideLoading();
            alert('Error al exportar XML: ' + error.message);
        }
    }

    function escapeCSV(str) {
        if (str === null || str === undefined) return '';
        str = String(str);
        str = str.replace(/"/g, '""');
        if (str.includes(',') || str.includes('\n') || str.includes('"')) {
            str = `"${str}"`;
        }
        return str;
    }

    function downloadFile(content, mimeType, baseFilename, extension) {
        const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${baseFilename}_${new Date().toISOString().slice(0,10)}.${extension}`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function escapeXML(str) {
        // Convertir a string primero, manejar null/undefined
        if (str === null || str === undefined) return '';

        // Convertir números y otros tipos a string
        str = String(str);

        // Escapar caracteres especiales
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
    }


    // ============================================
    // EVENT LISTENERS
    // ============================================

    document.addEventListener('DOMContentLoaded', function() {
        // Filtros
        const filterSearch = document.getElementById('filterSearch');
        const filterProject = document.getElementById('filterProject');
        const filterMetric = document.getElementById('filterMetric');
        const filterTool = document.getElementById('filterTool');

        if (filterSearch) filterSearch.addEventListener('input', filterTable);
        if (filterProject) filterProject.addEventListener('change', filterTable);
        if (filterMetric) filterMetric.addEventListener('change', filterTable);
        if (filterTool) filterTool.addEventListener('change', filterTable);

        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Ocultar loading cuando todo esté listo
        hideLoading();
    });

    // Mostrar loading al cambiar de página
    window.addEventListener('beforeunload', function() {
        showLoading('Cargando...', 'Un momento por favor');
    });
</script>
{% endblock %}