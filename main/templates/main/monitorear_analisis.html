{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>游늵 Monitor de An치lisis en Progreso</h2>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Los an치lisis se est치n ejecutando en segundo plano. Esta p치gina se actualiza autom치ticamente.
    </div>

    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Proyecto</th>
                    <th>Task ID</th>
                    <th>Estado</th>
                    <th>Progreso</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tasks-table">
                {% for task in tasks %}
                <tr id="task-row-{{ task.task_id }}">
                    <td>{{ task.project_name }}</td>
                    <td><code>{{ task.task_id|slice:":8" }}...</code></td>
                    <td>
                        <span class="badge bg-secondary task-status" data-task-id="{{ task.task_id }}">
                            Verificando...
                        </span>
                    </td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar task-progress" 
                                 data-task-id="{{ task.task_id }}"
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                0%
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary refresh-task" 
                                data-task-id="{{ task.task_id }}">
                            <i class="fas fa-sync"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <a href="{% url 'main:dashboardAnalisis' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
        </a>
        <button id="refresh-all" class="btn btn-primary">
            <i class="fas fa-sync"></i> Actualizar Todo
        </button>
    </div>
</div>

<script>
const taskIds = [
    {% for task in tasks %}
        "{{ task.task_id }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function updateTaskStatus(taskId) {
    fetch(`{% url 'main:verificar_tarea' task_id='TASK_ID' %}`.replace('TASK_ID', taskId))
        .then(response => response.json())
        .then(data => {
            // Actualizar badge de estado
            const statusBadge = document.querySelector(`.task-status[data-task-id="${taskId}"]`);
            const progressBar = document.querySelector(`.task-progress[data-task-id="${taskId}"]`);
            
            // Determinar color seg칰n estado
            let badgeClass = 'bg-secondary';
            if (data.state === 'SUCCESS') {
                badgeClass = 'bg-success';
            } else if (data.state === 'FAILURE') {
                badgeClass = 'bg-danger';
            } else if (data.state === 'STARTED') {
                badgeClass = 'bg-info';
            }
            
            statusBadge.className = `badge ${badgeClass} task-status`;
            statusBadge.textContent = data.status;
            
            // Actualizar barra de progreso
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            progressBar.setAttribute('aria-valuenow', data.progress);
            
            // Si termin칩, dejar de actualizar
            if (data.ready) {
                return data.ready;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function updateAllTasks() {
    taskIds.forEach(taskId => {
        updateTaskStatus(taskId);
    });
}

// Actualizar cada 3 segundos
setInterval(updateAllTasks, 3000);

// Actualizaci칩n inicial
updateAllTasks();

// Bot칩n de actualizar todo
document.getElementById('refresh-all').addEventListener('click', updateAllTasks);

// Botones individuales
document.querySelectorAll('.refresh-task').forEach(button => {
    button.addEventListener('click', function() {
        const taskId = this.dataset.taskId;
        updateTaskStatus(taskId);
    });
});
</script>
{% endblock %}