<!-- templates/main/monitorear_analisis.html -->
{% extends 'main/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h4>
                    {% if analysis_mode == 'parallel' %}
                    ‚ö° An√°lisis en Modo PARALELO
                    {% else %}
                    üîÑ An√°lisis en Modo SECUENCIAL
                    {% endif %}
                </h4>
                <p class="mb-0">
                    <strong>Proyectos:</strong> {{ tasks|length }} |
                    <strong>Workers:</strong> {{ workers }} |
                    <strong>Modo:</strong>
                    {% if analysis_mode == 'parallel' %}
                    SonarQube y SourceMeter ejecut√°ndose simult√°neamente
                    {% else %}
                    SonarQube ‚Üí SourceMeter (secuencial)
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="row">
        {% for task in tasks %}
        <div class="col-md-6 mb-3">
            <div class="card" id="task-{{ task.task_id }}">
                <div class="card-header">
                    <h5>{{ task.project_name }}</h5>
                    <small class="text-muted">Task ID: {{ task.task_id }}</small>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             style="width: 0%"
                             id="progress-{{ task.task_id }}">
                            0%
                        </div>
                    </div>
                    <p id="status-{{ task.task_id }}">Iniciando...</p>

                    <!-- Mostrar speedup si es paralelo -->
                    <div id="speedup-{{ task.task_id }}" class="alert alert-success d-none">
                        <strong>‚ö° Speedup:</strong> <span class="speedup-value"></span>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Monitoreo en tiempo real
const tasks = {{ tasks|safe }};
const checkInterval = 2000; // Cada 2 segundos

function checkTask(taskId) {
    fetch(`/verificar-tarea/${taskId}/`)
        .then(response => response.json())
        .then(data => {
            const progressBar = document.querySelector(`#progress-${taskId}`);
            const statusText = document.querySelector(`#status-${taskId}`);
            const speedupDiv = document.querySelector(`#speedup-${taskId}`);

            // Actualizar barra de progreso
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';

            // Actualizar estado
            statusText.textContent = data.status;

            // Si est√° completo
            if (data.state === 'SUCCESS') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');

                // Mostrar speedup si es paralelo
                if (data.mode === 'parallel' && data.speedup) {
                    speedupDiv.classList.remove('d-none');
                    speedupDiv.querySelector('.speedup-value').textContent =
                        `${data.speedup.toFixed(2)}x m√°s r√°pido (Ahorro: ${data.time_saved.toFixed(1)}s)`;
                }
            }

            // Si fall√≥
            if (data.state === 'FAILURE') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
            }
        })
        .catch(error => console.error('Error:', error));
}

// Iniciar monitoreo
tasks.forEach(task => {
    const interval = setInterval(() => {
        checkTask(task.task_id);
    }, checkInterval);

    // Primera verificaci√≥n inmediata
    checkTask(task.task_id);
});
</script>
{% endblock %}